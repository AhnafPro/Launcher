<h1>This is a background process.</h1>
<script type="text/javascript">
    const ipc = require('electron').ipcRenderer;
    const path = require('path');
    const fs = require('fs-extra');
    const files = require('../../util/files');

    const classifiers = {
        win32: 'windows',
        darwin: 'osx',
        linux: 'linux',
        sunos: 'linux',
        openbsd: 'linux',
        android: 'linux',
        aix: 'linux',
    };

    forceComplete = () => ipc.send('workers:libraries:vanilla');

    ipc.on('workers:libraries:vanilla', async (event, data) => {
        const libDir = path.join(data.installDir, 'libraries');
        const osName = classifiers[process.platform];
        const total = data.libraries.length;

        let index = 0;
        const callback = () => {
            index++;
            ipc.send('workers:libraries:vanilla:task', { task: 'downloading vanilla libraries', progress: index / total });
            if (index === total)
                ipc.send('workers:libraries:vanilla');
        };

        if (ipc.sendSync('config:get', 'app/parallelDownloads')) {
            data.libraries.forEach(async library => {
                new Promise(async resolve => {
                    if (!library.downloads)
                        return resolve();

                    if (library.rules)
                        for (let i = 0; i < library.rules.length; i++) {
                            if (library.rules[i].os === undefined)
                                continue;
                            if ((library.rules[i].os.name !== osName && library.rules[i].action === 'allow') || library.rules[i].os.name === osName && library.rules[i].action === 'deny')
                                return resolve();
                        }

                    if (library.downloads.artifact) {
                        const filePath = path.join(libDir, library.downloads.artifact.path);
                        if (!await fs.pathExists(filePath) || (await files.fileChecksum(filePath, 'sha1')) !== library.downloads.artifact.sha1)
                            await files.download(library.downloads.artifact.url, filePath);
                    }

                    if (!library.natives)
                        return resolve();
                    const native = library.natives[osName];
                    if (native === undefined)
                        return resolve();

                    const nativePath = path.join(libDir, library.downloads.classifiers[native].path);
                    if (!await fs.pathExists(nativePath) || (await files.fileChecksum(nativePath, 'sha1')) !== library.downloads.classifiers[native].sha1)
                        await files.download(library.downloads.classifiers[native].url, nativePath);

                    resolve();
                }).then(() => callback());
            });
        } else {
            libs:
            for (let i = 0; i < data.libraries.length; i++) {
                const library = data.libraries[i];
                if (!library.downloads) {
                    callback();
                    continue;
                }

                console.log('Downloading ' + library.name);
                //todo temp fix
                if (library.name === 'net.minecraftforge:forge:1.14.2-26.0.12:universal')
                    library.downloads.artifact.url = `https://files.minecraftforge.net/maven/${library.downloads.artifact.path}`;

                if (library.rules)
                    for (let i = 0; i < library.rules.length; i++) {
                        if (library.rules[i].os === undefined)
                            continue;
                        if ((library.rules[i].os.name !== osName && library.rules[i].action === 'allow') || library.rules[i].os.name === osName && library.rules[i].action === 'deny') {
                            callback();
                            continue libs;
                        }
                    }


                if (library.downloads.artifact) {
                    const filePath = path.join(libDir, library.downloads.artifact.path);
                    if (!await fs.pathExists(filePath) || (await files.fileChecksum(filePath, 'sha1')) !== library.downloads.artifact.sha1)
                        await files.download(library.downloads.artifact.url, filePath);
                }

                if (!library.natives) {
                    callback();
                    continue;
                }
                const native = library.natives[osName];
                if (native === undefined) {
                    callback();
                    continue;
                }

                const nativePath = path.join(libDir, library.downloads.classifiers[native].path);
                if (!await fs.pathExists(nativePath) || (await files.fileChecksum(nativePath, 'sha1')) !== library.downloads.classifiers[native].sha1)
                    await files.download(library.downloads.classifiers[native].url, nativePath);

                callback();
            }
        }
    });
</script>

